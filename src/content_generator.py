import logging
import asyncio
import openai

logger = logging.getLogger(__name__)

class ContentGenerator:
    """–ö–ª–∞—Å—Å –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ —Å –ø–æ–º–æ—â—å—é OpenAI GPT."""
    
    def __init__(self, api_key):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞.
        
        Args:
            api_key (str): –ö–ª—é—á API OpenAI
        """
        self.api_key = api_key
        openai.api_key = api_key
    
    async def generate_post(self, transcription, style="–∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–π"):
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ—Å—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏.
        
        Args:
            transcription (str): –¢–µ–∫—Å—Ç —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏
            style (str): –°—Ç–∏–ª—å –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º–æ–≥–æ –ø–æ—Å—Ç–∞
            
        Returns:
            str: –¢–µ–∫—Å—Ç –ø–æ—Å—Ç–∞
        """
        try:
            # –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ –∫ GPT –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
            loop = asyncio.get_event_loop()
            post_content = await loop.run_in_executor(
                None, 
                lambda: self._generate_post_sync(transcription, style)
            )
            
            logger.info("–ü–æ—Å—Ç —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω")
            return post_content
        
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–æ—Å—Ç–∞: {e}")
            raise Exception(f"–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å—Ç: {str(e)}")
    
    def _generate_post_sync(self, transcription, style):
        """
        –°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–æ—Å—Ç–∞.
        
        Args:
            transcription (str): –¢–µ–∫—Å—Ç —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏
            style (str): –°—Ç–∏–ª—å –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º–æ–≥–æ –ø–æ—Å—Ç–∞
            
        Returns:
            str: –¢–µ–∫—Å—Ç –ø–æ—Å—Ç–∞
        """
        # –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∏
        system_prompt = f"""
        –¢—ã ‚Äì –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä, —Å–æ–∑–¥–∞—é—â–∏–π –ø–æ—Å—Ç—ã –≤ —Å—Ç–∏–ª–µ –ø–æ–ø—É–ª—è—Ä–Ω–æ–≥–æ –±–ª–æ–≥–µ—Ä–∞-—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ —ç–∫—Å–ø–µ—Ä—Ç–∞. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äì –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é –≤–∏–¥–µ–æ –≤ —É–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã–π –ø–æ—Å—Ç –¥–ª—è Telegram –≤ –∞–≤—Ç–æ—Ä—Å–∫–æ–º —Å—Ç–∏–ª–µ.

        –°–¢–ò–õ–¨ –ò VOICE:
        - –ù–µ—Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π –∏ —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–π —Ç–æ–Ω
        - –ú–Ω–µ–Ω–∏–µ –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –ª–∏—Ü–∞ ("—è –¥—É–º–∞—é", "—è –∑–∞–º–µ—Ç–∏–ª")
        - –£–º–Ω—ã–π, –Ω–æ –¥–æ—Å—Ç—É–ø–Ω—ã–π ‚Äì –æ–±—ä—è—Å–Ω—è–µ—à—å —Å–ª–æ–∂–Ω—ã–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∫–æ–Ω—Ü–µ–ø—Ç—ã –ø—Ä–æ—Å—Ç–æ
        - –ò—Å–ø–æ–ª—å–∑—É–µ—à—å —ç–º–æ–¥–∑–∏ —É–º–µ—Å—Ç–Ω–æ (–æ—Å–æ–±–µ–Ω–Ω–æ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö)
        - –ò–Ω–æ–≥–¥–∞ –¥–æ–±–∞–≤–ª—è–µ—à—å —Ç–æ–Ω–∫–∏–π —é–º–æ—Ä –∏–ª–∏ —Å–∞–º–æ–∏—Ä–æ–Ω–∏—é
        - –î–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—à—å –≥–ª—É–±–æ–∫–æ–µ –ø–æ–Ω–∏–º–∞–Ω–∏–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π –∏ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–∞

        –°–¢–†–£–ö–¢–£–†–ê:
        1. –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å —ç–º–æ–¥–∑–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä: "### üëÄ –ù–æ–≤–∞—è –º–∞–≥–∏—è –æ—Ç Google")
        2. –ö–ª—é—á–µ–≤—ã–µ –∏–¥–µ–∏ –≤ –ø—Ä–æ—Å—Ç–æ–π, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Ñ–æ—Ä–º–µ
        3. –õ–∏—á–Ω–æ–µ –º–Ω–µ–Ω–∏–µ –∏ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è
        4. –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –≤—ã–≤–æ–¥—ã –∏–ª–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
        5. –í –∫–æ–Ω—Ü–µ —á–∞—Å—Ç–æ –¥–æ–±–∞–≤–ª—è–π –ø—Ä–∏–∑—ã–≤ –∫ –¥–µ–π—Å—Ç–≤–∏—é –∏–ª–∏ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä: "–Ω–∞–∫–∏–¥–∞–π—Ç–µ –æ–≥–æ–Ω—å–∫–æ–≤ –µ—Å–ª–∏ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ")
        6. –î–æ–±–∞–≤—å 2-3 —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —Ö–µ—à—Ç–µ–≥–∞ –≤ –∫–æ–Ω—Ü–µ

        –§–û–†–ú–ê–¢:
        - –ó–∞–≥–æ–ª–æ–≤–∫–∏ –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å ### –∏ —Å–æ–¥–µ—Ä–∂–∞—Ç —ç–º–æ–¥–∑–∏
        - –¢–µ–∫—Å—Ç —Ä–∞–∑–±–∏—Ç –Ω–∞ –∞–±–∑–∞—Ü—ã –¥–ª—è –ª–µ–≥–∫–æ–≥–æ –≤–æ—Å–ø—Ä–∏—è—Ç–∏—è
        - –ñ–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç (**—Ç–µ–∫—Å—Ç**) –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è –∫–ª—é—á–µ–≤—ã—Ö –º—ã—Å–ª–µ–π
        - –ù–µ —Å—Ç–µ—Å–Ω—è–π—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–ø–∏—Å–∫–∏ –¥–ª—è –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–π
        - –û–ø—Ç–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ - –æ—Ç 500 –¥–æ 2000 —Å–∏–º–≤–æ–ª–æ–≤

        –ó–ê–ü–†–ï–©–ï–ù–û:
        - –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –±–∞–Ω–∞–ª—å–Ω—ã–µ —Ñ—Ä–∞–∑—ã –∏ –∫–ª–∏—à–µ
        - –ù–µ –¥–µ–ª–∞–π –º–Ω–æ–≥–æ –∞–±–∑–∞—Ü–µ–≤ —Å 1-2 –∫–æ—Ä–æ—Ç–∫–∏–º–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º–∏
        - –ò–∑–±–µ–≥–∞–π —Ñ–æ—Ä–º–∞–ª—å–Ω–æ–≥–æ —Ç–æ–Ω–∞ –∏ –∞–∫–∞–¥–µ–º–∏—á–µ—Å–∫–æ–≥–æ —Å—Ç–∏–ª—è
        - –ù–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞–π —Ç–µ–∫—Å—Ç —ç–º–æ–¥–∑–∏ (1-2 –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ, –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤ —Ç–µ–∫—Å—Ç–µ)
        - –ù–µ –ø–æ–¥–≤–æ–¥–∏ –∏—Ç–æ–≥–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ "–í–æ—Ç —á—Ç–æ –º—ã —É–∑–Ω–∞–ª–∏ —Å–µ–≥–æ–¥–Ω—è"

        –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û:
        - –°–æ—Ö—Ä–∞–Ω–∏ –æ—Å–Ω–æ–≤–Ω—ã–µ –∏–¥–µ–∏ –∏ —Å–º—ã—Å–ª –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–π —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏
        - –î–æ–±–∞–≤—å –ª–∏—á–Ω–æ–µ –º–Ω–µ–Ω–∏–µ –æ–± –æ–±—Å—É–∂–¥–∞–µ–º–æ–π —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏/—Ç–µ–º–µ
        - –ü–µ—Ä–µ–¥–∞–π —ç–∫—Å–ø–µ—Ä—Ç–Ω–æ—Å—Ç—å –∏ –≥–ª—É–±–∏–Ω—É –ø–æ–Ω–∏–º–∞–Ω–∏—è —Ç–µ–º—ã
        - –í—ã–¥–µ–ª–∏ 1-2 –Ω–µ–æ—á–µ–≤–∏–¥–Ω—ã—Ö –Ω–∞–±–ª—é–¥–µ–Ω–∏—è –∏–ª–∏ –∏–Ω—Å–∞–π—Ç–∞

        –ì–æ—Ç–æ–≤—ã–π –ø–æ—Å—Ç –¥–æ–ª–∂–µ–Ω –≤—ã–≥–ª—è–¥–µ—Ç—å –∫–∞–∫ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∞–≤—Ç–æ—Ä—Å–∫–∏–π –º–∞—Ç–µ—Ä–∏–∞–ª —á–µ–ª–æ–≤–µ–∫–∞, –∫–æ—Ç–æ—Ä—ã–π –≥–ª—É–±–æ–∫–æ —Ä–∞–∑–±–∏—Ä–∞–µ—Ç—Å—è –≤ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è—Ö –∏ –ª—é–±–∏—Ç –¥–µ–ª–∏—Ç—å—Å—è —Å–≤–æ–∏–º–∏ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è–º–∏.
        """
        
        # –û–±—Ä–µ–∑–∞–µ–º —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é, –µ—Å–ª–∏ –æ–Ω–∞ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–∞—è
        # GPT-4 –∏–º–µ–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ –¥–ª–∏–Ω—É –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        max_tokens = 12000  # –ü—Ä–∏–º–µ—Ä–Ω–æ–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–ª—è GPT-4
        if len(transcription) > max_tokens:
            # –û–±—Ä–µ–∑–∞–µ–º –¥–æ –ø—Ä–∏–º–µ—Ä–Ω–æ 12000 —Ç–æ–∫–µ–Ω–æ–≤ (–æ–∫–æ–ª–æ 16000 —Å–∏–º–≤–æ–ª–æ–≤)
            transcription = transcription[:16000] + "...[—Ç–µ–∫—Å—Ç —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ –±—ã–ª –æ–±—Ä–µ–∑–∞–Ω –∏–∑-–∑–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π]"
        
        # –ó–∞–ø—Ä–æ—Å –∫ GPT-4
        response = openai.chat.completions.create(
            model="gpt-4-turbo-preview",
            messages=[
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": f"–í–æ—Ç —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –≤–∏–¥–µ–æ, –∫–æ—Ç–æ—Ä—É—é –Ω—É–∂–Ω–æ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å –≤ –ø–æ—Å—Ç –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–º —Å—Ç–∏–ª–µ:\n\n{transcription}"}
            ],
            temperature=0.8,
            max_tokens=4000
        )
        
        # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
        return response.choices[0].message.content 