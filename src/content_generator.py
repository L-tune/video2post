import logging
import asyncio
import openai

logger = logging.getLogger(__name__)

class ContentGenerator:
    """Класс для генерации текстового контента на основе транскрипции с помощью OpenAI GPT."""
    
    def __init__(self, api_key):
        """
        Инициализация генератора контента.
        
        Args:
            api_key (str): Ключ API OpenAI
        """
        self.api_key = api_key
        openai.api_key = api_key
    
    async def generate_post(self, transcription, style="информативный"):
        """
        Генерирует текстовый пост на основе транскрипции.
        
        Args:
            transcription (str): Текст транскрипции
            style (str): Стиль генерируемого поста
            
        Returns:
            str: Текст поста
        """
        try:
            # Выполнение запроса к GPT в отдельном потоке
            loop = asyncio.get_event_loop()
            post_content = await loop.run_in_executor(
                None, 
                lambda: self._generate_post_sync(transcription, style)
            )
            
            logger.info("Пост успешно сгенерирован")
            return post_content
        
        except Exception as e:
            logger.error(f"Ошибка при генерации поста: {e}")
            raise Exception(f"Не удалось сгенерировать пост: {str(e)}")
    
    def _generate_post_sync(self, transcription, style):
        """
        Синхронный метод для генерации поста.
        
        Args:
            transcription (str): Текст транскрипции
            style (str): Стиль генерируемого поста
            
        Returns:
            str: Текст поста
        """
        # Системный промпт для определения задачи
        system_prompt = f"""
        Ты – профессиональный редактор, создающий посты в стиле популярного блогера-технологического эксперта. Твоя задача – преобразовать транскрипцию видео в увлекательный пост для Telegram в авторском стиле.

        СТИЛЬ И VOICE:
        - Неформальный и разговорный тон
        - Мнение от первого лица ("я думаю", "я заметил")
        - Умный, но доступный – объясняешь сложные технические концепты просто
        - БЕЗ ЭМОДЗИ - не используй их вообще
        - Иногда добавляешь тонкий юмор или самоиронию
        - Демонстрируешь глубокое понимание технологий и маркетинга

        СТРУКТУРА:
        1. Заголовок без эмодзи (например: "Новая магия от Google")
        2. Ключевые идеи в простой, структурированной форме
        3. Личное мнение и наблюдения
        4. Практические выводы или рекомендации
        5. В конце часто добавляй призыв к действию или интерактивный элемент (например: "накидайте огоньков если интересно")
        6. Добавь 2-3 релевантных хештега в конце без символов # (просто слова через пробел)

        ФОРМАТ ДЛЯ TELEGRAM:
        - Заголовки выделяй **жирным текстом**
        - Текст разбивай на абзацы для легкого восприятия
        - Используй *курсив* для выделения важных фраз
        - Для списков используй дефисы (-) или звездочки (*)
        - Для кода и технических терминов используй `код`
        - Оптимальная длина - от 500 до 2000 символов
        - Между абзацами оставляй пустую строку

        ЗАПРЕЩЕНО:
        - Не используй эмодзи совсем
        - Не используй банальные фразы и клише
        - Не делай много абзацев с 1-2 короткими предложениями
        - Избегай формального тона и академического стиля
        - Не подводи итоги в формате "Вот что мы узнали сегодня"
        - Не используй сложное форматирование, недоступное в Telegram

        ОБЯЗАТЕЛЬНО:
        - Сохрани основные идеи и смысл оригинальной транскрипции
        - Добавь личное мнение об обсуждаемой технологии/теме
        - Передай экспертность и глубину понимания темы
        - Выдели 1-2 неочевидных наблюдения или инсайта
        - Используй только поддерживаемое в Telegram форматирование: **жирный**, *курсив*, `код`, ~~зачеркнутый~~

        Готовый пост должен выглядеть как оригинальный авторский материал человека, который глубоко разбирается в технологиях и любит делиться своими наблюдениями.
        """
        
        # Обрезаем транскрипцию, если она слишком длинная
        # GPT-4 имеет ограничение на длину контекста
        max_tokens = 12000  # Примерное ограничение для GPT-4
        if len(transcription) > max_tokens:
            # Обрезаем до примерно 12000 токенов (около 16000 символов)
            transcription = transcription[:16000] + "...[текст транскрипции был обрезан из-за ограничений]"
        
        # Запрос к GPT-4
        response = openai.chat.completions.create(
            model="gpt-4-turbo-preview",
            messages=[
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": f"Вот транскрипция видео, которую нужно преобразовать в пост в указанном стиле:\n\n{transcription}"}
            ],
            temperature=0.8,
            max_tokens=4000
        )
        
        # Извлечение сгенерированного текста
        return response.choices[0].message.content 